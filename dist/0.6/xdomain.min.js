// XDomain - v0.6.1 - https://github.com/jpillora/xdomain
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2014
!function(a,b,c){!function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=[].slice;o=a.document,d="before",c="after",k="readyState",j="addEventListener",i="removeEventListener",g="dispatchEvent",m="XMLHttpRequest",h="FormData",l=["load","loadend","loadstart"],e=["progress","abort","error","timeout"],(u=Array.prototype).indexOf||(u.indexOf=function(a){var b,c,d,e;for(b=d=0,e=this.length;e>d;b=++d)if(c=this[b],c===a)return b;return-1}),s=function(a,b){return Array.prototype.slice.call(a,b)},q=function(a,b){var c,d;for(c in a)if(d=a[c],"returnValue"!==c)try{b[c]=a[c]}catch(e){}return b},r=function(a,b,c){var d,e,f,h;for(e=function(a){return function(d){var e,f,h;e={};for(f in d)"returnValue"!==f&&(h=d[f],e[f]=h===b?c:h);return c[g](a,e)}},f=0,h=a.length;h>f;f++)d=a[f],b["on"+d]=e(d)},p=function(a){var b;if(null!=o.createEventObject)return b=o.createEventObject(),b.type=a,b;try{return new Event(a)}catch(c){return{type:a}}},f=function(a){var c,d,e;return d={},e=function(a){return d[a]||[]},c={},c[j]=function(a,c,f){d[a]=e(a),d[a].indexOf(c)>=0||(f=f===b?d[a].length:f,d[a].splice(f,0,c))},c[i]=function(a,b){var c;c=e(a).indexOf(b),-1!==c&&e(a).splice(c,1)},c[g]=function(){var d,f,g,h,i,j,k,l;for(d=s(arguments),f=d.shift(),a||(d[0]=q(d[0],p(f))),h=c["on"+f],h&&h.apply(b,d),l=e(f).concat(e("*")),g=j=0,k=l.length;k>j;g=++j)i=l[g],i.apply(b,d)},a&&(c.listeners=function(a){return s(e(a))},c.on=c[j],c.off=c[i],c.fire=c[g],c.once=function(a,b){var d;return d=function(){return c.off(a,d),b.apply(null,arguments)},c.on(a,d)},c.destroy=function(){return d={}}),c},t=f(!0),t.EventEmitter=f,t[d]=function(a,b){if(a.length<1||a.length>2)throw"invalid hook";return t[j](d,a,b)},t[c]=function(a,b){if(a.length<2||a.length>3)throw"invalid hook";return t[j](c,a,b)},n=t.headers=function(a,b){var c,d,e,f,g,h;switch(null==b&&(b={}),typeof a){case"object":d=[];for(e in a)f=a[e],d.push(""+e+":	"+f);return d.join("\n");case"string":for(d=a.split("\n"),g=0,h=d.length;h>g;g++)c=d[g],/([^:]+):\s*(.+)/.test(c)&&(b[RegExp.$1]||(b[RegExp.$1]=RegExp.$2));return b}},t[h]=a[h],a[h]=function(){var a=this;this.fd=new t[h],this.entries=[],this.append=function(){var b;return b=1<=arguments.length?v.call(arguments,0):[],a.entries.push(b),a.fd.append.apply(a.fd,b)}},t[m]=a[m],a[m]=function(){var b,i,o,p,s,u,v,w,x,y,z;return z=new t[m],w=!1,s={},s.headers={},u={},u.headers={},p=function(){var a,b,c;u.status=z.status,u.statusText=z.statusText,c=n(z.getAllResponseHeaders());for(a in c)b=c[a],u.headers[a]||(u.headers[a]=b)},o=function(){try{u.text=z.responseText}catch(a){}try{u.xml=z.responseXML}catch(a){}u.data=z.response||u.text},y=function(){i.status=u.status,i.statusText=u.statusText},x=function(){i.response=u.data||u.text||null,i.responseText=u.text||"",i.responseXML=u.xml||null},b=0,v=function(a){var d,e,f;return d=function(){for(;a>b&&4>b;)i[k]=++b,1===b&&i[g]("loadstart",{}),2===b&&y(),4===b&&(y(),x()),i[g]("readystatechange",{}),4===b&&(i[g]("load",{}),i[g]("loadend",{}))},4>a?(d(),void 0):(e=t.listeners(c),f=function(){var a;return e.length?(a=e.shift(),2===a.length?(a(s,u),f()):3===a.length?a(s,u,f):void 0):d()},f(),void 0)},z.onreadystatechange=function(){try{2===z[k]&&p()}catch(a){}4===z[k]&&(w=!1,p(),o()),v(z[k])},i=s.xhr=f(),i[j]("progress",function(){return v(3)}),r(e,z,i),i.withCredentials=!1,i.response=null,i.status=0,i.open=function(a,b,c,d,e){if(s.method=a,s.url=b,c===!1)throw"sync xhr not supported by XHook";s.user=d,s.pass=e,v(1)},i.send=function(b){var c,e,f,g,j,k,l,m;for(m=["type","timeout"],k=0,l=m.length;l>k;k++)e=m[k],f="type"===e?"responseType":e,s[e]=i[f];s.body=b,j=function(){var b,c,d,g,i,j;for(w=!0,z.open(s.method,s.url,!0,s.user,s.pass),i=["type","timeout"],d=0,g=i.length;g>d;d++)e=i[d],f="type"===e?"responseType":e,z[f]=s[e];j=s.headers;for(b in j)c=j[b],z.setRequestHeader(b,c);s.body instanceof a[h]&&(s.body=s.body.fd),z.send(s.body)},c=t.listeners(d),g=function(){var a,b;return c.length?(a=function(a){return"object"!=typeof a||"number"!=typeof a.status&&"number"!=typeof u.status?(g(),void 0):(q(a,u),v(4),void 0)},a.head=function(a){return q(a,u),v(2)},a.progress=function(a){return q(a,u),v(3)},b=c.shift(),1===b.length?a(b(s)):2===b.length?b(s,a):void 0):j()},g()},i.abort=function(){w&&z.abort(),i[g]("abort",{})},i.setRequestHeader=function(a,b){s.headers[a]=b},i.getResponseHeader=function(a){return u.headers[a]},i.getAllResponseHeaders=function(){return n(u.headers)},z.overrideMimeType&&(i.overrideMimeType=function(){return z.overrideMimeType.apply(z,arguments)}),z.upload&&(i.upload=s.upload=f(),r(e.concat(l),z.upload,i.upload)),i},this.xhook=t}(this);var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W;G=null,h=function(a){var b,c;null===G&&(G={},t());for(b in a)c=a[b],G[b]=c},p={},q=function(a,c){var d;return p[a]?p[a]:(d=b.createElement("iframe"),d.id=d.name=r(),d.src=a+c,d.setAttribute("style","display:none;"),b.body.appendChild(d),p[a]=d.contentWindow)},t=function(){return xhook.before(function(a,b){var c,d,e,f;return e=C(a.url),e&&G[e.origin]?(z("proxying request slave: '"+e.origin+"'"),a.async===!1?(M("sync not supported"),b()):(c=q(e.origin,G[e.origin]),f=j(c),f.on("response",function(a){return b(a),f.close()}),a.xhr.addEventListener("abort",function(){return f.emit("abort")}),f.on("xhr-event",function(){return a.xhr.dispatchEvent.apply(null,arguments)}),f.on("xhr-upload-event",function(){return a.xhr.upload.dispatchEvent.apply(null,arguments)}),d=K(a),d.headers=a.headers,v(a.body,"FormData")&&(d.body=["XD_FD",a.body.entries]),v(a.body,"Uint8Array")&&(d.body=a.body),f.emit("request",d),void 0)):(e&&z("no slave matching: '"+e.origin+"'"),b())})},A=null,g=function(a){var b,c;null===A&&(A={},u());for(b in a)c=a[b],A[b]=c},u=function(){return y(function(a,b){var c,d,e,f;"null"===a&&(a="*"),e=null;for(c in A){f=A[c];try{if(d=L(c),d.test(a)){e=L(f);break}}catch(g){}}return e?(b.once("request",function(a){var c,d,g,h,i,j,k,l,m,n;if(z("request: "+a.method+" "+a.url),h=C(a.url),!h||!e.test(h.path))return M("blocked request to path: '"+h.path+"' by regex: "+f),b.close(),void 0;j=new XMLHttpRequest,j.open(a.method,a.url),j.addEventListener("*",function(a){return b.emit("xhr-event",a.type,K(a))}),j.upload&&j.upload.addEventListener("*",function(a){return b.emit("xhr-upload-event",a.type,K(a))}),b.once("abort",function(){return j.abort()}),j.onreadystatechange=function(){var a;if(4===j.readyState){a={status:j.status,statusText:j.statusText,data:j.response,headers:xhook.headers(j.getAllResponseHeaders())};try{a.text=j.responseText}catch(c){}return b.emit("response",a)}},a.timeout&&(j.timeout=a.timeout),a.type&&(j.responseType=a.type),m=a.headers;for(g in m)i=m[g],j.setRequestHeader(g,i);if(a.body instanceof Array&&"XD_FD"===a.body[0]){for(d=new xhook.FormData,n=a.body[1],k=0,l=n.length;l>k;k++)c=n[k],d.append.apply(d,c);a.body=d}j.send(a.body||null)}),z("slave listening for requests on socket: "+b.id),void 0):(M("blocked request from: '"+a+"'"),void 0)}),a===a.parent?M("slaves must be in an iframe"):a.parent.postMessage("XDPING_"+e,"*")},B=function(c){return b.addEventListener?a.addEventListener("message",c):a.attachEvent("onmessage",c)},s=null,I={},w=!0,f="XD_CHECK",J=function(){return B(function(a){var b,d,e,f;if(b=a.data,"string"==typeof b){if(/^XPING_/.test(b))return M("your master is not compatible with your slave, check your xdomain.js verison");if(/^xdomain-/.test(b))b=b.split(",");else try{b=JSON.parse(b)}catch(g){return}}if(b instanceof Array&&(e=b.shift(),/^xdomain-/.test(e)&&(f=I[e],null!==f))){if(f===c){if(!s)return;f=l(e,a.source),s(a.origin,f)}d="string"==typeof b[1]?": '"+b[1]+"'":"",z("receive socket: "+e+": '"+b[0]+"'"+d),f.fire.apply(f,b)}})},l=function(a,b){var c,e,g,h,i,j;return i=!1,j=I[a]=xhook.EventEmitter(!0),j.id=a,j.once("close",function(){return j.destroy(),j.close()}),h=[],j.emit=function(){var b,c;b=H(arguments),c="string"==typeof b[1]?": '"+b[1]+"'":"",z("send socket: "+a+": "+b[0]+c),b.unshift(a),i?g(b):h.push(b)},g=function(a){w&&(a=JSON.stringify(a)),b.postMessage(a,"*")},j.close=function(){j.emit("close"),z("close socket: "+a),I[a]=null},j.once(f,function(b){for(w="string"==typeof b,i=!0,z("ready socket: "+a);h.length;)g(h.shift())}),e=0,c=function(){b.postMessage([a,f,i,{}],"*"),i||(e++===N.timeout/d?M("Timeout waiting on iframe socket"):setTimeout(c,d))},setTimeout(c),z("new socket: "+a),j},j=function(a){var b;return b=l(r(),a)},y=function(a){s=a},m=location.protocol+"//"+location.host,r=function(){return"xdomain-"+Math.round(Math.random()*Math.pow(2,32)).toString(16)},H=function(a,b){return Array.prototype.slice.call(a,b)},E=function(a){return"xdomain ("+m+"): "+a},k=a.console||{},z=function(a){N.debug&&(a=E(a),"log"in k&&k.log(a))},M=function(a){a=E(a),"warn"in k?k.warn(a):alert(a)},U=["postMessage","JSON"];for(O=0,R=U.length;R>O;O++)if(n=U[O],!a[n])return M("requires '"+n+"' and this browser does not support it"),void 0;for(v=function(b,c){return"function"!=typeof a[c]?!1:b instanceof a[c]},e="V1",C=function(a){return/(https?:\/\/[^\/\?]+)(\/.*)?/.test(a)?{origin:RegExp.$1,path:RegExp.$2}:(z("failed to parse url: "+a),null)},L=function(a){var b;return a instanceof RegExp?a:(b=a.toString().replace(/\W/g,function(a){return"\\"+a}).replace(/\\\*/g,".+"),new RegExp("^"+b+"$"))},K=function(a){var b,c,d,e;b={};for(c in a)"returnValue"!==c&&(d=a[c],"function"!=(e=typeof d)&&"object"!==e&&(b[c]=d));return b},N=function(a){a&&(a.masters&&g(a.masters),a.slaves&&h(a.slaves))},N.debug=!1,N.masters=g,N.slaves=h,N.parseUrl=C,N.origin=m,N.timeout=15e3,d=100,a.xdomain=N,i={slave:function(a){var b,c;return(b=C(a))?(c={},c[b.origin]=b.path,h(c)):void 0},master:function(a){var b;if(a)return b={},b[a]=/./,g(b)},debug:function(a){return"string"==typeof a?N.debug="false"!==a:void 0}},V=b.getElementsByTagName("script"),P=0,S=V.length;S>P;P++)if(F=V[P],/xdomain/.test(F.src))for(W=["","data-"],Q=0,T=W.length;T>Q;Q++){D=W[Q];for(x in i)o=i[x],o(F.getAttribute(D+x))}J()}(window,document);